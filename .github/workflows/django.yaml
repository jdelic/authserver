name: Django CI

on:
    push:
        branches: [ "develop" ]
    pull_request:
        branches: [ "develop" ]

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            statuses: write
        strategy:
            max-parallel: 4
            matrix:
                python-version: ["3.13"]
        env:
            SECRET_KEY: "secretsekrit"
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip wheel
                  pip install -e .
                  pip install mypy typing-extensions django-stubs types-cryptography types-requests types-jwt
#            - name: Run Mypy
#              run: >
#                  mypy --ignore-missing-imports --install-types --non-interactive
#                  --follow-imports=skip --disallow-untyped-calls --disallow-untyped-defs
#                  authserver
            - name: Start PostgreSQL
              run: |
                  sudo systemctl start postgresql.service
                  pg_isready
            - name: Set up PostgreSQL
              run: |
                  sudo -u postgres psql --command="CREATE USER authserver WITH CREATEDB LOGIN PASSWORD 'authserver'" --command="\du"
                  sudo -u postgres createdb -O authserver -p 5432 authserver
            - name: Run Tests
              run: |
                  mkdir -p .envdir
                  echo "authserver.settings" > .envdir/DJANGO_SETTINGS_MODULE
                  echo "authserver" > .envdir/DATABASE_NAME
                  echo "authserver" > .envdir/DATABASE_USER
                  echo "authserver" > .envdir/DATABASE_PASSWORD
                  echo "maurus.networks" > .envdir/AUTHSERVER_ENTITY_NAME
                  echo "/static/mn.png" > .envdir/AUTHSERVER_ENTITY_LOGO
                  envdir .envdir django-admin migrate
                  envdir .envdir django-admin domain create smoke.example.com
                  envdir .envdir django-admin domain list --format json
                  envdir .envdir django-admin group create smokegroup
                  envdir .envdir django-admin group list --format json
                  envdir .envdir django-admin permissions create --name "Smoke Permission" smoke.permission
                  envdir .envdir django-admin permissions list --format json
                  envdir .envdir django-admin mailinglist create smokelist first@example.com
                  envdir .envdir django-admin mailinglist add-address -m smokelist second@example.com
                  envdir .envdir django-admin user create smoke-user "Smoke User" --password smoke123
                  envdir .envdir django-admin emailalias create smoke-user@smoke.example.com -u smoke-user
                  envdir .envdir django-admin emailalias create smoke-user-temp@smoke.example.com -u smoke-user
                  envdir .envdir django-admin user set-delivery-mailbox smoke-user smoke-user@smoke.example.com
                  envdir .envdir django-admin serviceuser create -u smoke-user --username smoke-svc --password smoke123
                  envdir .envdir django-admin emailalias blacklist smoke-user-temp@smoke.example.com
                  envdir .envdir django-admin emailalias unblacklist smoke-user-temp@smoke.example.com
                  envdir .envdir django-admin dockerauth registry create --client-id smoke-reg --name smoke-reg --domain smoke.example.com
                  envdir .envdir django-admin dockerauth registry show --name smoke-reg
                  envdir .envdir django-admin dockerauth registry remove --name smoke-reg -y
                  envdir .envdir django-admin serviceuser remove smoke-svc -y
                  envdir .envdir django-admin emailalias remove smoke-user-temp@smoke.example.com -y
                  envdir .envdir django-admin user deactivate smoke-user -y
                  envdir .envdir django-admin mailinglist remove smokelist -y
                  envdir .envdir django-admin permissions remove smoke.permission
                  envdir .envdir django-admin group remove smokegroup
                  envdir .envdir django-admin collectstatic --noinput
                  envdir .envdir django-admin test authserver.tests mailauth.tests
