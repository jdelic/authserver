name: Django CI

on:
    push:
        branches: [ "develop" ]
    pull_request:
        branches: [ "develop" ]

jobs:
    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            statuses: write
        strategy:
            max-parallel: 4
            matrix:
                python-version: ["3.13"]
        env:
            SECRET_KEY: "secretsekrit"
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip wheel
                  pip install -e .
                  pip install mypy typing-extensions django-stubs types-cryptography types-requests types-jwt
#            - name: Run Mypy
#              run: >
#                  mypy --ignore-missing-imports --install-types --non-interactive
#                  --follow-imports=skip --disallow-untyped-calls --disallow-untyped-defs
#                  authserver
            - name: Start PostgreSQL
              run: |
                  sudo systemctl start postgresql.service
                  pg_isready
            - name: Set up PostgreSQL
              run: |
                  sudo -u postgres psql --command="CREATE USER authserver WITH CREATEDB LOGIN PASSWORD 'authserver'" --command="\du"
                  sudo -u postgres createdb -O authserver -p 5432 authserver
            - name: Run Tests
              run: |
                  mkdir -p .envdir
                  echo "authserver" > .envdir/DATABASE_NAME
                  echo "authserver" > .envdir/DATABASE_USER
                  echo "authserver" > .envdir/DATABASE_PASSWORD
                  echo "maurus.networks" > .envdir/AUTHSERVER_ENTITY_NAME
                  echo "/static/mn.png" > .envdir/AUTHSERVER_ENTITY_LOGO
                  envdir .envdir django-admin migrate --settings=authserver.settings
                  envdir .envdir django-admin collectstatic --noinput --settings=authserver.settings
                  envdir .envdir django-admin test --settings=authserver.settings authserver.tests
