name: Django CI

on:
    push:
        branches: [ "develop" ]
    pull_request:
        branches: [ "develop" ]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 4
            matrix:
                python-version: ["3.12", "3.13"]

        steps:
            - uses: actions/checkout@v4
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip wheel
                  pip install -e .
                  pip install mypy typing-extensions django-stubs types-cryptography types-requests types-jwt
            - name: Run Mypy
              run: |
                  mypy --ignore-missing-imports --install-types --non-interactive \ 
                  --follow-imports=skip --disallow-untyped-calls --disallow-untyped-defs \ 
                  authserver
            - name: Start PostgreSQL
              run: |
                  sudo systemctl start postgresql.service
                  pg_isready
            - name: Set up PostgreSQL
              run: |
                  sudo -u postgres psql --command="CREATE USER authserver WITH CREATEDB LOGIN PASSWORD 'authserver'" --command="\du"
                  sudo -u postgres createdb -O authserver -p 5432 authserver
            - name: Run Tests
              run: |
                  mkdir -p /etc/appconfig/authserver/env
                  echo "authserver" > /etc/appconfig/authserver/env/DATABASE_NAME
                  echo "authserver" > /etc/appconfig/authserver/env/DATABASE_USER
                  echo "authserver" > /etc/appconfig/authserver/env/DATABASE_PASSWORD
                  echo "maurus.networks" > /etc/appconfig/authserver/env/AUTHSERVER_ENTITY_NAME
                  echo "/static/mn.png" > /etc/appconfig/authserver/env/AUTHSERVER_ENTITY_LOGO
                  django-admin migrate --settings=authserver.settings
                  django-admin collectstatic --noinput --settings=authserver.settings
                  django-admin test --settings=authserver.settings --parallel 4 --keepdb --noinput
